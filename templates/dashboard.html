<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - Customer Support Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Customer Support Assistant</h1>
            <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
        </div>
        
        <div id="chat-box">
            <!-- Chat history will be loaded here -->
            <div class="welcome-message">
                Hello! I'm your customer support assistant. You can type or speak your questions. How can I help you today?
            </div>
            <!-- Suggested questions will appear here -->
            <div id="suggested-questions" class="suggested-questions">
                <div class="suggestion-chip" onclick="askQuestion('Where can I find my invoice?')">Where can I find my invoice?</div>
                <div class="suggestion-chip" onclick="askQuestion('Why is my order delayed?')">Why is my order delayed?</div>
                <div class="suggestion-chip" onclick="askQuestion('How do I return an item?')">How do I return an item?</div>
            </div>
        </div>
        
        <div class="input-area">
            <button id="voice-input-btn" class="voice-btn" title="Click to speak">
                <i class="fas fa-microphone"></i>
            </button>
            <input type="text" id="user-input" placeholder="Type your question here...">
            <button id="send-btn">Send</button>
            <button id="voice-output-btn" class="voice-btn" title="Toggle voice output">
                <i class="fas fa-volume-up"></i>
            </button>
        </div>
    </div>

    <script>
        // Check if browser supports speech recognition
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        
        // Check if browser supports speech synthesis
        const speechSynthesis = window.speechSynthesis;
        
        // Voice state
        let isListening = false;
        let voiceOutputEnabled = true;
        
        // Configure speech recognition
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        
        // Event listeners for buttons
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('user-input').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Voice input button
        document.getElementById('voice-input-btn').addEventListener('click', toggleVoiceInput);
        
        // Voice output button
        document.getElementById('voice-output-btn').addEventListener('click', toggleVoiceOutput);
        
        // Speech recognition events
        recognition.onstart = function() {
            isListening = true;
            updateVoiceInputButton();
            document.getElementById('user-input').placeholder = "Listening...";
        };
        
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            document.getElementById('user-input').value = transcript;
            sendMessage();
        };
        
        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            isListening = false;
            updateVoiceInputButton();
            document.getElementById('user-input').placeholder = "Type your question here...";
            addBotMessage("Sorry, I couldn't understand what you said. Please try again or type your question.");
        };
        
        recognition.onend = function() {
            isListening = false;
            updateVoiceInputButton();
            document.getElementById('user-input').placeholder = "Type your question here...";
        };
        
        function toggleVoiceInput() {
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }
        
        function toggleVoiceOutput() {
            voiceOutputEnabled = !voiceOutputEnabled;
            updateVoiceOutputButton();
        }
        
        function updateVoiceInputButton() {
            const btn = document.getElementById('voice-input-btn');
            if (isListening) {
                btn.classList.add('listening');
                btn.innerHTML = '<i class="fas fa-stop"></i>';
            } else {
                btn.classList.remove('listening');
                btn.innerHTML = '<i class="fas fa-microphone"></i>';
            }
        }
        
        function updateVoiceOutputButton() {
            const btn = document.getElementById('voice-output-btn');
            if (voiceOutputEnabled) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        }
        
        function speakText(text) {
            if (!voiceOutputEnabled || !speechSynthesis) return;
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9; utterance.pitch = 1; utterance.volume = 0.8;
            speechSynthesis.speak(utterance);
        }

        function askQuestion(question) {
            document.getElementById('user-input').value = question;
            sendMessage();
        }

        function addBotMessage(text) {
            const chatBox = document.getElementById('chat-box');
            const messageContainer = document.createElement('div');
            messageContainer.className = 'message-container';
            
            const botMessageDiv = document.createElement('div');
            botMessageDiv.className = 'message bot-message';
            botMessageDiv.textContent = text;
            messageContainer.appendChild(botMessageDiv);

            // Add feedback buttons
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'message-feedback';
            feedbackDiv.innerHTML = `
                <button class="feedback-btn" onclick="sendFeedback('${text.replace(/'/g, "\\'")}', 'up')" title="Helpful">
                    <i class="fas fa-thumbs-up"></i>
                </button>
                <button class="feedback-btn" onclick="sendFeedback('${text.replace(/'/g, "\\'")}', 'down')" title="Not Helpful">
                    <i class="fas fa-thumbs-down"></i>
                </button>
            `;
            messageContainer.appendChild(feedbackDiv);

            chatBox.appendChild(messageContainer);
            chatBox.scrollTop = chatBox.scrollHeight;
            saveChatHistory();
        }

        function sendFeedback(message, feedbackType) {
            fetch('/log_feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message, feedback: feedbackType })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Feedback logged successfully');
                    // Optionally, disable the feedback buttons after submission
                    event.target.disabled = true;
                } else {
                    console.error('Error logging feedback:', data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function saveChatHistory() {
            const chatBox = document.getElementById('chat-box');
            localStorage.setItem('chatHistory', chatBox.innerHTML);
        }

        function loadChatHistory() {
            const chatHistory = localStorage.getItem('chatHistory');
            if (chatHistory) {
                document.getElementById('chat-box').innerHTML = chatHistory;
            }
        }

        function sendMessage() {
            const userInput = document.getElementById('user-input');
            const message = userInput.value.trim();
            if (message === '') return;

            // Hide suggested questions after first interaction
            const suggestedQuestions = document.getElementById('suggested-questions');
            if (suggestedQuestions) {
                suggestedQuestions.style.display = 'none';
            }

            const chatBox = document.getElementById('chat-box');
            
            // Add user message
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'message user-message';
            userMessageDiv.textContent = message;
            chatBox.appendChild(userMessageDiv);
            
            // Clear input
            userInput.value = '';
            
            // Scroll to bottom
            chatBox.scrollTop = chatBox.scrollHeight;
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            chatBox.appendChild(typingIndicator);
            chatBox.scrollTop = chatBox.scrollHeight;

            // Send request to server
            fetch('/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: message })
            })
            .then(response => response.json())
            .then(data => {
                chatBox.removeChild(typingIndicator);
                const responseText = data.response || 'Sorry, I could not understand that.';
                addBotMessage(responseText); // This function now also adds feedback buttons
                speakText(responseText);
            })
            .catch(error => {
                chatBox.removeChild(typingIndicator);
                console.error('Error:', error);
                const responseText = 'An error occurred. Please try again.';
                addBotMessage(responseText);
                speakText(responseText);
            });
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadChatHistory();
            updateVoiceOutputButton();
        });
    </script>
</body>
</html>